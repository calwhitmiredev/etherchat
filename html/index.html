<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Etherchat!</title>

    <link rel="stylesheet" type="text/css" href="main.css">
</head>
<body>
    <button onclick="PostButton()" style="background: url(images/viewpost.png); background-repeat:no-repeat;"> </button>

    <h1>Ethereum Smart-Contracts Test</h1>
        
    <hr>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script> 
    <script async type="text/javascript" src="shoco/shoco.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
    <script src="FastInt/FastIntegerCompression.js"></script>

    <script>

        var Web3 = require('web3'); 
        var web3 = new Web3();
        web3.setProvider(new web3.providers.HttpProvider('http://localhost:8545'));
        var address = new String();
        var FastIntegerCompression = require("fastintcompression");

        var EthProjContract = web3.eth.contract([ { "constant": false, "inputs": [ { "name": "_userName", "type": "uint8[]" } ], "name": "setUsername", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [ { "name": "_fMessage", "type": "uint8[]" } ], "name": "setMessage", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "anonymous": false, "inputs": [ { "indexed": false, "name": "message", "type": "uint8[]" }, { "indexed": false, "name": "add", "type": "address" }, { "indexed": false, "name": "cost", "type": "uint256" } ], "name": "Message", "type": "event" }, { "anonymous": false, "inputs": [ { "indexed": false, "name": "name", "type": "uint8[]" }, { "indexed": false, "name": "add", "type": "address" }, { "indexed": false, "name": "cost", "type": "uint256" } ], "name": "Username", "type": "event" } ]);
        var EthProj = EthProjContract.at('0xF1BA0Cd57F3A831E018201fb2B74D7E56D39D50b');
        console.log(EthProjContract);

        var intervalID = window.setInterval(update, 10000);
        var prevName = new String();
        var prevMessage = new String();
        var messages = new String();
        var tempString = "";
        var senderName = "";

        var getMessage = function(messageToGet, placeToSet){
            messages = "";

            var i = 0;
            var names = new String();
            var startcut = 0;
            var name = new String();

            var Message = EthProj.Message({}, { fromBlock: 0, toBlock: 'latest'});
            Message.watch((error, results) => {
                i++;
                messages = "";
                messages = JSON.stringify(results.args);
                console.log(messages);

                if(i === messageToGet) { 
                    var Username = EthProj.Username({}, { fromBlock: 0, toBlock: 'latest'});
                    Username.watch((error, reuslts) => {
                        if(name != null) {
                            name = JSON.stringify(reuslts.args);
                            if(name.split(",")[1].split(":")[1] === messages.split(":")[2].split(",")[0].split("}")[0]) {
                                senderName = name.split(",")[0].split(":")[1];
                                console.log(senderName);
                            } else {
                                senderName = "No Name";
                            }
                        }
                    });

                    if(messages.split(":")[1].split(",")[0] != '""') {
                        tempString = ((messages.split(":")[1].split(",")[0] + " (From: " + senderName + ")").replace(/"/g, ''));
                        console.log(tempString);
                    } else {
                        tempString = (("(no included text) " + " (From: " + senderName + ")").replace(/"/g, ''));
                    }
                    if((messages.split(":")[1].split(",")[0] === undefined) || (messages.split(":")[2].split(")")[0] === undefined)) {
                        return;
                    }

                    if(document.getElementById("Message" + placeToSet) != null) {
                        document.getElementById("Message" + placeToSet).remove();
                        if(document.getElementById("hr" + placeToSet) != null) {
                            document.getElementById("hr" + placeToSet).remove();
                        }
                    }

                    if(document.getElementById("Message" + placeToSet) === null) {
                        var newh2 = document.createElement('h2');
                        newh2.setAttribute("id", ("Message" + placeToSet));
                        var text = document.createTextNode(shoco.decompress(tempString));
                        newh2.appendChild(text);
                        document.body.appendChild(newh2);

                        console.log(text);

                        var newHR = document.createElement('hr');
                        newHR.setAttribute("id", ("hr" + placeToSet));
                    }
                }                
            });
        }

        function update(){
            tempString = "";
            //console.clear();
            for(var i = 0; i < 10; i++) {
                getMessage(i , i);
            }
        }

        update();

        function PostButton() {
            window.location.href = "file:///D:/etherchat/html/post.html";
        }
    </script>

</body>
</html>